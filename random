# Function to extract topics and frequencies from the LDA model
def extract_lda_topics(lda_model, corpus, topn=10):
    # Extracting topics and their word distributions
    topic_summary = []
    
    for i, topic in lda_model.show_topics(num_topics=lda_model.num_topics, formatted=False):
        # Unpack each word and its associated probability (word, probability)
        topic_words = [word for word, _ in topic]
        
        # Summing up the frequency for each topic across the corpus
        topic_frequency = sum([freq for topic_num, freq in lda_model.get_document_topics(corpus, minimum_probability=0.0) if topic_num == i])
        
        # Append the topic number, top words, and topic frequency to the summary
        topic_summary.append((i, ' '.join(topic_words[:topn]), int(topic_frequency)))  # Show top 'topn' words in the topic
    
    # Convert to DataFrame for easier plotting
    topics_df = pd.DataFrame(topic_summary, columns=['Topic Number', 'Topic Name', 'Frequency'])
    return topics_df

# Function to plot LDA topic frequency
def plot_lda_topics(topics_df):
    plt.figure(figsize=(12, 6))
    
    # Sort topics by frequency for better visual presentation
    topics_df = topics_df.sort_values(by='Frequency', ascending=False)
    
    sns.barplot(x='Topic Name', y='Frequency', data=topics_df, palette='coolwarm')

    # Adding text labels on bars for each frequency value
    for index, value in enumerate(topics_df['Frequency']):
        plt.text(index, value, str(value), ha='center', va='bottom', fontsize=10)

    plt.xticks(rotation=45, ha='right')
    plt.title('LDA Topic Frequency Summary', fontsize=14)
    plt.tight_layout()
    plt.show()

# Main Code Execution

# Assume 'non_rst_cleaned' is the dataframe with preprocessed data
# Apply LDA and print the ngrams
processed_texts = non_rst_cleaned['processed_text'].apply(lambda x: x.split()).tolist()  # Assuming tokenize_text is already defined
lda_model, corpus, dictionary, processed_texts_with_ngrams = apply_lda(processed_texts, num_topics=10)

# Extract topics and their frequency counts
topics_df = extract_lda_topics(lda_model, corpus)

# Print the topic summary table
print("\n==== LDA Topic Frequency Summary ====\n")
print(topics_df.to_string(index=False))

# Plot LDA topics and their frequencies
plot_lda_topics(topics_df)

# Compute and print the coherence score
coherence_score = compute_coherence_score(lda_model, processed_texts_with_ngrams, dictionary)
print(f"\nCoherence Score for the LDA Model: {coherence_score:.4f}")
