import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import OneHotEncoder, KBinsDiscretizer
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, r2_score

# 1. Load Excel file
df = pd.read_excel("your_excel_file.xlsx")  # Replace with actual file name

# 2. EDA Summary
print("\nColumn Names:")
print(df.columns.tolist())
print(f"\nDataset Shape: {df.shape[0]} rows × {df.shape[1]} columns")

print("\nMissing Value Check:")
missing = df.isnull().sum()
missing = missing[missing > 0]
if not missing.empty:
    print(missing)
else:
    print("No missing values found.")

# 3. Date Range Info
print("\nData Time Range:")
print(f"From {pd.to_datetime(df['as_of_date'].min()).date()} to {pd.to_datetime(df['as_of_date'].max()).date()}")

# 4. Drop rows with nulls
df = df.dropna()
print(f"\nAfter dropping nulls: {df.shape[0]} rows remain")

# 5. Feature selection
binary_categorical_features = [
    "browser_access_flag", "jpm_lockbox_image_file_flag", "non_jpm_lockbox_image_file_flag",
    "self_scanning_lockbox_image_file_flag", "pdf_image_file_to_835_flag", "patient_payment_flag",
    "paper_eob_conversion_to_835_flag", "835_outbound_transmission_commercial_era_uploading_flag",
    "epic_cash_management_file_flag", "835_outbound_transmission_commercial_flag",
    "835_outbound_transmission_patientpay_flag", "outbound_hcl_image_transmission_flag",
    "reconciliation_manager_flag", "reconciliation_manager_enterprise_flag", "corr_index_flag",
    "835_packet_split_flag", "fispan_flag"
]

multi_categorical_features = ["pli_type"]
categorical_features = binary_categorical_features + multi_categorical_features
target = "pli_active_cycle_time"

X = df[categorical_features]
y = df[target]

# 6. Preprocessing pipeline
preprocessor = ColumnTransformer([
    ("cat", OneHotEncoder(drop='first', handle_unknown='ignore'), categorical_features)
])

pipeline = Pipeline([
    ("preprocessor", preprocessor),
    ("regressor", LinearRegression())
])

# 7. Train-test split
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 8. Fit model
pipeline.fit(X_train, y_train)

# 9. Predict
y_pred = pipeline.predict(X_test)

# 10. Evaluation
print("\nModel Evaluation:")
print(f"MAE: {mean_absolute_error(y_test, y_pred):.2f}")
print(f"R² Score: {r2_score(y_test, y_pred):.2f}")

# 11. Predict for full dataset
df["predicted_cycle_time"] = pipeline.predict(X)

# 12. Binning complexity scores
binning = KBinsDiscretizer(n_bins=5, encode='ordinal', strategy='quantile')
df["complexity_score"] = binning.fit_transform(df[["predicted_cycle_time"]]).astype(int) + 1

# 13. Plot: Actual vs Predicted
plt.figure(figsize=(8, 5))
sns.scatterplot(x=y_test, y=y_pred)
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], 'r--')
plt.xlabel("Actual Cycle Time")
plt.ylabel("Predicted Cycle Time")
plt.title("Actual vs Predicted (Test Set)")
plt.grid(True)
plt.tight_layout()
plt.show()

# 14. Plot: Complexity Score Distribution
plt.figure(figsize=(6, 4))
sns.countplot(x="complexity_score", data=df)
plt.title("Complexity Score Distribution")
plt.xlabel("Complexity (1 = Low, 5 = High)")
plt.tight_layout()
plt.show()

# 15. Feature Importance from Coefficients
regressor = pipeline.named_steps["regressor"]
onehot = pipeline.named_steps["preprocessor"].named_transformers_["cat"]
feature_names = onehot.get_feature_names_out(categorical_features)

coef_df = pd.DataFrame({
    "Feature": feature_names,
    "Coefficient": regressor.coef_
}).sort_values(by="Coefficient", key=abs, ascending=False)

print("\nTop Feature Coefficients:")
print(coef_df.head(10))

# Optional: save coefficients to Excel
coef_df.to_excel("feature_importance_linear_model.xlsx", index=False)

# 16. Save Final Output
df.to_excel("pli_with_complexity_scores.xlsx", index=False)
print("Excel saved as 'pli_with_complexity_scores.xlsx'")
# 17. Plot: Top Feature Importances
top_n = 15  # Change this number to see more or fewer features
top_features = coef_df.head(top_n)

plt.figure(figsize=(10, 6))
sns.barplot(x="Coefficient", y="Feature", data=top_features, palette="viridis")
plt.title(f"Top {top_n} Feature Importances (Linear Regression)")
plt.xlabel("Coefficient Value (Impact on Cycle Time)")
plt.ylabel("Feature")
plt.tight_layout()
plt.grid(True, axis='x')
plt.show()
